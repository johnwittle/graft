#!/bin/bash
# claude-sub: Wrapper for Claude Code that archives sessions
# Usage: claude-sub [task-description] [claude args...]
#
# If first arg doesn't start with -, it's treated as a task description
# for the archive metadata.

ARCHIVE_DIR="$HOME/.claude-archive"
SESSIONS_LOG="$ARCHIVE_DIR/sessions.log"
RAW_DIR="$ARCHIVE_DIR/raw"

# Generate session ID
SESSION_ID=$(date +%Y%m%d-%H%M%S)-$$

# Parse task description if provided
TASK_DESC=""
if [[ $# -gt 0 && ! "$1" =~ ^- ]]; then
    TASK_DESC="$1"
    shift
fi

# Record session start
echo "[$SESSION_ID] START $(date -Iseconds)" >> "$SESSIONS_LOG"
echo "[$SESSION_ID] TASK: ${TASK_DESC:-unspecified}" >> "$SESSIONS_LOG"
echo "[$SESSION_ID] CWD: $(pwd)" >> "$SESSIONS_LOG"
echo "[$SESSION_ID] ARGS: $*" >> "$SESSIONS_LOG"

# Capture the project directory Claude Code will use
# (It mangles paths like /home/ssm-user -> -home-ssm-user)
PROJECT_DIR_MANGLED=$(pwd | sed 's|^/||; s|/|-|g')
if [ -z "$PROJECT_DIR_MANGLED" ]; then
    PROJECT_DIR_MANGLED="-"
fi
CLAUDE_PROJECT_DIR="$HOME/.claude/projects/-$PROJECT_DIR_MANGLED"

# Get list of existing session files before running
EXISTING_SESSIONS=""
if [ -d "$CLAUDE_PROJECT_DIR" ]; then
    EXISTING_SESSIONS=$(ls "$CLAUDE_PROJECT_DIR"/*.jsonl 2>/dev/null | sort)
fi

# Run Claude Code
claude "$@"
EXIT_CODE=$?

# Find new session files
NEW_SESSIONS=""
if [ -d "$CLAUDE_PROJECT_DIR" ]; then
    CURRENT_SESSIONS=$(ls "$CLAUDE_PROJECT_DIR"/*.jsonl 2>/dev/null | sort)
    # Find sessions that didn't exist before
    NEW_SESSIONS=$(comm -13 <(echo "$EXISTING_SESSIONS") <(echo "$CURRENT_SESSIONS") 2>/dev/null)
fi

# Archive new sessions
if [ -n "$NEW_SESSIONS" ]; then
    for SESSION_FILE in $NEW_SESSIONS; do
        BASENAME=$(basename "$SESSION_FILE")
        ARCHIVE_NAME="${SESSION_ID}_${BASENAME}"
        cp "$SESSION_FILE" "$RAW_DIR/$ARCHIVE_NAME"
        echo "[$SESSION_ID] ARCHIVED: $ARCHIVE_NAME" >> "$SESSIONS_LOG"
    done
else
    echo "[$SESSION_ID] NO_SESSION_FILE" >> "$SESSIONS_LOG"
fi

# Record session end
echo "[$SESSION_ID] END $(date -Iseconds) exit=$EXIT_CODE" >> "$SESSIONS_LOG"
echo "" >> "$SESSIONS_LOG"

exit $EXIT_CODE
